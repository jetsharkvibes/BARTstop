<style>
/* Card styling */
.train-card {
  border-radius: 12px;
  padding: 10px;
  display: flex;
  flex-direction: column;
  gap: 0px;
  height: 100%;
}

/* Typography */
.destination-header {
  font-size: 1.5em;
  font-weight: bold;
  letter-spacing: 0.3px;
}

/* Spacing */
.spacing-xs { margin-top: 4px; }

/* Dividers */
.divider-footer { border-color: rgba(255,255,255,0.09); }

/* Time badges */
.times-row {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}
.time-badge {
  background: white;
  border-radius: 10px;
  padding: 10px 14px;
  color: #000;
  font-weight: bold;
  font-size: 15px;
  white-space: nowrap;
}
</style>

{% assign station = root.station[0] %}
{% assign pst_offset = 3600 | times: -8 %}
{% assign now_utc = "now" | date: "%s" %}
{% assign now_pst = now_utc | plus: pst_offset %}

<div class="title_bar">
  <img class="image" src="/images/plugins/trmnl--render.svg">
  <span class="title">{{ station.name }} BART</span>
  
  <span class="instance">{{ trmnl.plugin_settings.custom_fields_values.bart_direction | capitalize }}</span>
</div>
<div class="layout layout--col gap--small">
  <div class="header">
    {% if bart_direction and bart_direction != "" %}
      <div class="label label--small text--gray-60 spacing-xs">
        Direction: {{ bart_direction | capitalize }}
      </div>
    {% endif %}
  </div>

  <div class="grid grid--cols-2 gap--small">
    {% assign destinations_shown = "" %}
    {% assign card_count = 0 %}

    {% if station.etd %}
      {% for etd in station.etd %}
        {% if card_count < 4 %}
          {% assign line_abbr = etd.abbreviation %}

          <!-- Skip if destination filter exists and this destination is not in it -->
          {% if bart_destinations and bart_destinations != '' %}
            {% assign filter_string = ',' | append: bart_destinations | append: ',' %}
            {% assign search_string = ',' | append: line_abbr | append: ',' %}
            {% unless filter_string contains search_string %}
              {% continue %}
            {% endunless %}
          {% endif %}

          {% unless destinations_shown contains line_abbr %}
            <div class="item bg--black train-card">
              
                       <div class="value value--medium text--gray-60">
                {{ etd.abbreviation }}
              </div>
              <div class="times-row">
                {% for est in etd.estimate limit:8 %}
                  <div class="time-badge">
                    {% if est.minutes == 'Leaving' or est.minutes == '0' %}
                      Now
                    {% else %}
                      {% assign arrival_seconds = est.minutes | times: 60 %}
                      {% assign arrival_timestamp = now_pst | plus: arrival_seconds %}
                      {% assign arrival_time_str = arrival_timestamp | date: "%-I:%M %p" %}
                      {{ arrival_time_str }}
                    {% endif %}
                  </div>
                {% endfor %}
              </div>
            </div>
            {% assign destinations_shown = destinations_shown | append: line_abbr | append: "," %}
            {% assign card_count = card_count | plus: 1 %}
          {% endunless %}
        {% endif %}
      {% endfor %}
    {% endif %}

    {% if card_count == 0 %}
      <div class="item bg--black train-card" style="grid-column: 1 / -1;">
        <div class="content layout--col gap--small" style="width: 100%; text-align: center;">
          <div class="value value--xlarge text--white">⚠️</div>
          <div class="label label--small text--gray-40">No trains available</div>
        </div>
      </div>
    {% endif %}
  </div>

  <div class="footer">
    <div class="divider divider-footer"></div>
    <div class="label label--small text--gray-50"></div>
    {% if last_updated %}
      <div class="label label--small text--gray-60">Updated {{ last_updated }}</div>
    {% endif %}
  </div>
</div>