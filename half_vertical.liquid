<style>
.card-vertical { border-radius: 12px; padding: 2px 57px; }
.time-display { line-height: 1.0; }
.spacing-xxs { margin-top: 2px; }
.gap-xxs { gap: 4px; }
.layout-vertical { gap: 4px; margin: 0; padding: 0; }
.header-vertical { margin: 0 0 2px 0; padding: 0; }
.title-vertical { margin: 0; padding: 0; }
.content-vertical { gap: 0; margin: ; padding: 0;  }
.badge-row { display: flex; gap: 3px; flex-wrap: nowrap; }
.badge-on { background: white; border-radius: 12px; padding: 8px; color: #000; font-weight: bold; font-size: 14px; white-space: nowrap; }
</style>

{% assign station = root.station[0] %}
{% assign pst_offset = 3600 | times: -8 %}
{% assign now_utc = "now" | date: "%s" %}
{% assign now_pst = now_utc | plus: pst_offset %}

{% comment %} Convert badge_visibility array to string - using proper TRMNL path {% endcomment %}
{% assign badge_visibility_raw = trmnl.plugin_settings.custom_fields_values.badge_visibility %}
{% if badge_visibility_raw %}
  {% assign badge_visibility_str = badge_visibility_raw | join: "," %}
{% else %}
  {% assign badge_visibility_str = "platform,bike,delay,cancel" %}
{% endif %}

<div class="layout layout--col layout-vertical">
  <div class="title_bar">
    <img class="image" src="/images/plugins/trmnl--render.svg">
    <span class="title">{{ station.name }}</span>
  </div>

  <div class="header header-vertical">
    {% if bart_direction and bart_direction != "" %}
      <div class="label label--small text--gray-40 spacing-xxs">
        Direction: {{ bart_direction | capitalize }}
      </div>
    {% endif %}
  </div>

  <div class="layout layout--col gap-xxs">
    {% assign train_count = 0 %}
    {% assign shown_lines = "" %}

    {% if station.etd %}
      <!-- First pass: show first train of each unique line -->
      {% for etd in station.etd %}
        {% if etd.estimate and train_count < 4 %}
          {% assign line_abbr = etd.abbreviation %}

          <!-- Skip if destination filter exists and this destination is not in it -->
          {% if bart_destinations and bart_destinations != '' %}
            {% assign filter_string = ',' | append: bart_destinations | append: ',' %}
            {% assign search_string = ',' | append: line_abbr | append: ',' %}
            {% unless filter_string contains search_string %}
              {% continue %}
            {% endunless %}
          {% endif %}

          {% unless shown_lines contains line_abbr %}
            {% assign est = etd.estimate[0] %}
            <div class="item bg--black card-vertical">
              <div class="content content-vertical">
                <div class="value value--small text--gray-70" style="letter-spacing: 0.2px; font-size: 1.10em;">
                  {{ etd.abbreviation }}
                </div>
                <div class="value value--small text--white time-display" style="font-size: 1.75em;">
                  {% if est.minutes == 'Leaving' or est.minutes == '0' %}
                    Now
                  {% else %}
                    {% assign arrival_seconds = est.minutes | times: 60 %}
                    {% assign arrival_timestamp = now_pst | plus: arrival_seconds %}
                    {% assign arrival_time_str = arrival_timestamp | date: "%-I:%M %p" %}
                    {{ arrival_time_str }}
                  {% endif %}
                </div>

                {% unless badge_visibility_str contains "no_badges" %}
                  <div class="badge-row spacing-xxs">
                    {% if badge_visibility_str contains "platform" %}
                      <div class="badge-on">PLAT {{ est.platform }}</div>
                    {% endif %}

                    {% if badge_visibility_str contains "bike" %}
                      {% if est.bikeflag == "1" %}
                        <div class="badge-on">BIKE</div>
                      {% else %}
                        <span class="label label--xsmall label--inverted text--gray-40">BIKE</span>
                      {% endif %}
                    {% endif %}

                    {% assign delay_num = est.delay | plus: 0 %}
                    {% if est.canceled == "1" %}
                      {% if badge_visibility_str contains "cancel" %}
                        <div class="badge-on">CANCEL</div>
                      {% endif %}
                    {% elsif badge_visibility_str contains "delay" %}
                      {% if delay_num > 0 %}
                        <div class="badge-on">DELAY</div>
                      {% else %}
                        <span class="label label--xsmall label--inverted text--gray-40">DELAY</span>
                      {% endif %}
                    {% endif %}
                  </div>
                {% endunless %}
              </div>
            </div>
            {% assign train_count = train_count | plus: 1 %}
            {% assign shown_lines = shown_lines | append: line_abbr | append: "," %}
          {% endunless %}
        {% endif %}
      {% endfor %}

      <!-- Second pass: fill remaining slots with any additional trains -->
      {% for etd in station.etd %}
        {% if etd.estimate and train_count < 4 %}
          {% assign line_abbr = etd.abbreviation %}

          <!-- Skip if destination filter exists and this destination is not in it -->
          {% if bart_destinations and bart_destinations != '' %}
            {% assign filter_string = ',' | append: bart_destinations | append: ',' %}
            {% assign search_string = ',' | append: line_abbr | append: ',' %}
            {% unless filter_string contains search_string %}
              {% continue %}
            {% endunless %}
          {% endif %}

          {% for est in etd.estimate offset:1 %}
            {% if train_count < 4 %}
              <div class="item bg--black card-vertical">
                <div class="content content-vertical">
                  <div class="value value--small text--gray-70" style="letter-spacing: 0.2px; font-size: 1.10em;">
                    {{ etd.abbreviation }}
                  </div>
                  <div class="value value--small text--white time-display" style="font-size: 1.75em;">
                    {% if est.minutes == 'Leaving' or est.minutes == '0' %}
                      Now
                    {% else %}
                      {% assign arrival_seconds = est.minutes | times: 60 %}
                      {% assign arrival_timestamp = now_pst | plus: arrival_seconds %}
                      {% assign arrival_time_str = arrival_timestamp | date: "%-I:%M %p" %}
                      {{ arrival_time_str }}
                    {% endif %}
                  </div>

                  {% unless badge_visibility_str contains "no_badges" %}
                    <div class="badge-row spacing-xxs">
                      {% if badge_visibility_str contains "platform" %}
                        <div class="badge-on">PLAT {{ est.platform }}</div>
                      {% endif %}

                      {% if badge_visibility_str contains "bike" %}
                        {% if est.bikeflag == "1" %}
                          <div class="badge-on">BIKE</div>
                        {% else %}
                          <span class="label label--xsmall label--inverted text--gray-40">BIKE</span>
                        {% endif %}
                      {% endif %}

                      {% assign delay_num = est.delay | plus: 0 %}
                      {% if est.canceled == "1" %}
                        {% if badge_visibility_str contains "cancel" %}
                          <div class="badge-on">CANCEL</div>
                        {% endif %}
                      {% elsif badge_visibility_str contains "delay" %}
                        {% if delay_num > 0 %}
                          <div class="badge-on">DELAY</div>
                        {% else %}
                          <span class="label label--xsmall label--inverted text--gray-40">DELAY</span>
                        {% endif %}
                      {% endif %}
                    </div>
                  {% endunless %}
                </div>
              </div>
              {% assign train_count = train_count | plus: 1 %}
            {% endif %}
          {% endfor %}
        {% endif %}
      {% endfor %}
    {% endif %}

    {% if train_count == 0 %}
      <div class="item bg--black card-vertical">
        <div class="content content-vertical">
          <div class="value value--xlarge text--white">⚠️</div>
          <div class="label label--small text--gray-40">No trains available</div>
        </div>
      </div>
    {% endif %}
  </div>
</div>