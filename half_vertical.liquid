{% assign line_map = 'Pittsburg/Bay Point:PITT,Berryessa/North San José:BERY,Millbrae:MLBR,Richmond:RICH,Daly City:DALY,Warm Springs/South Fremont:WARM,Antioch:ANTC,Dublin/Pleasanton:DUBL,SFO International Airport:SFIA,Oakland Airport:OAKL,OAK Airport / Dublin/Pleasanton:DUBL' | split: ',' %}
{% assign station = root.station[0] %}
{% assign pst_offset = 3600 | times: -8 %}
{% assign now_utc = "now" | date: "%s" %}
{% assign now_pst = now_utc | plus: pst_offset %}

<div class="layout layout--col" style="gap:4px; margin:0; padding:0;">
  <div class="header" style="margin:0 0 2px 0; padding:0;">
    <div class="title title--large text--black" style="margin:0; padding:0;">{{ station.name }}</div>
    {% if bart_direction and bart_direction != "" %}
      <div class="label label--xsmall text--gray-40" style="margin:2px 0 0 0; padding:0;">
        Direction: {{ bart_direction | capitalize }}
      </div>
    {% endif %}
  </div>

  <div class="layout layout--col" style="gap:4px; padding:0; margin:0;">
    {% assign train_count = 0 %}
    {% assign seen_trains = '' %}
    {% if station.etd %}
      {% for etd in station.etd %}
        {% if etd.estimate %}
          {% for est in etd.estimate %}
            {% if train_count < 4 %}
              {% comment %} Create unique key for deduplication: destination-platform-minutes {% endcomment %}
              {% assign train_key = etd.abbreviation | append: '-' | append: est.platform | append: '-' | append: est.minutes %}

              {% comment %} Only show if not already seen {% endcomment %}
              {% unless seen_trains contains train_key %}
                {% assign seen_trains = seen_trains | append: '|' | append: train_key | append: '|' %}

                {% comment %} Correct direction based on destination {% endcomment %}
                {% assign corrected_direction = est.direction %}
                {% if etd.abbreviation == 'BERY' or etd.abbreviation == 'WARM' %}
                  {% assign corrected_direction = 'South' %}
                {% elsif etd.abbreviation == 'RICH' or etd.abbreviation == 'ANTC' or etd.abbreviation == 'PITT' %}
                  {% assign corrected_direction = 'North' %}
                {% elsif etd.abbreviation == 'DALY' or etd.abbreviation == 'MLBR' or etd.abbreviation == 'SFIA' %}
                  {% assign corrected_direction = 'North' %}
                {% elsif etd.abbreviation == 'DUBL' %}
                  {% assign corrected_direction = 'North' %}
                {% endif %}

                <div class="item bg--black" style="border-radius:12px; padding:12px 57px; margin:0;">
                  <div class="content" style="gap:0; margin:0; padding:0;">
                    {% assign train_line = etd.destination %}
                    {% assign train_line_trim = train_line | strip | downcase %}
                    {% assign to_abbr = '' %}
                    {% for pair in line_map %}
                      {% assign parts = pair | split: ':' %}
                      {% assign map_key = parts[0] | strip | downcase %}
                      {% if train_line_trim == map_key %}
                        {% assign to_abbr = parts[1] %}
                      {% endif %}
                    {% endfor %}
                    <div class="value value--large text--gray-70" style="letter-spacing:0.2px; font-size:1.10em; margin:0; padding:0; line-height:1;">
                      {{ etd.abbreviation | default: to_abbr | default: train_line }}
                    </div>
                    <div class="value value--xlarge text--white" style="line-height:1; font-size:1.75em; margin:0; padding:0;">
                      {% if est.minutes == 'Leaving' or est.minutes == '0' or est.minutes == '-1' %}
                        Now
                      {% else %}
                        {% assign arrival_seconds = est.minutes | times: 60 %}
                        {% assign arrival_timestamp = now_pst | plus: arrival_seconds %}
                        {% assign arrival_time_str = arrival_timestamp | date: "%-I:%M %p" %}
                        {{ arrival_time_str }}
                      {% endif %}
                    </div>
                    {% if corrected_direction %}
                      <div class="label label--xsmall text--gray-40" style="margin:2px 0 0 0; padding:0; line-height:1;">
                        {{ corrected_direction }}
                      </div>
                    {% endif %}
                  </div>
                </div>
                {% assign train_count = train_count | plus: 1 %}
              {% endunless %}
            {% endif %}
          {% endfor %}
        {% endif %}
      {% endfor %}
    {% endif %}
    {% if train_count == 0 %}
      <div class="item bg--black" style="border-radius:12px; padding:7px; margin:0;">
        <div class="content" style="gap:0; margin:0; padding:0;">
          <div class="value value--xlarge text--white">⚠️</div>
          <div class="label label--small text--gray-40" style="margin:0;">No trains available</div>
        </div>
      </div>
    {% endif %}
  </div>
</div>
